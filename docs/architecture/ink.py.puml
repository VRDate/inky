@startuml ink.py – Python Proto-Generated Model (ink.py.model)

' ==============================================================================
' ink.py.model — Python Protobuf Generated Model
' Package: ink.py.model
' Source:  ink-kmp-mcp/src/pyMain/ink/py/model/
'
' Generated by: protoc v5.28.3 via proto-gen.sh
'   protoc --python_out / --pyi_out → post-processed by sed:
'     sed 's/ink\.model/ink.py.model/g; s/ink_dot_model/ink_dot_py_dot_model/g'
'
' Runtime: google.protobuf v5.28.3
'   - DESCRIPTOR = descriptor_pool.Default().AddSerializedFile(b'...')
'   - _builder.BuildMessageAndEnumDescriptors(DESCRIPTOR, globals())
'   - _builder.BuildTopDescriptorsAndMessages(DESCRIPTOR, module, globals())
'   - Message classes: google.protobuf.message.Message subclasses
'   - Enum descriptors: int + enum_type_wrapper.EnumTypeWrapper
'   - Type stubs: .pyi files (mypy/pyright compatible)
'
' 16 _pb2.py files | 70 messages | 20 enums | 16 .pyi stub files
'
' Last updated: 2026-03-01
' ==============================================================================

skinparam backgroundColor #FFFDF5
skinparam shadowing false
skinparam roundcorner 8

skinparam class {
    BackgroundColor #FFF8E1
    BorderColor #E65100
    HeaderBackgroundColor #FF8F00
    FontColor #212121
    FontName JetBrains Mono
    FontSize 11
    HeaderFontColor #FFFFFF
    HeaderFontSize 12
    AttributeFontSize 10
    StereotypeFontSize 9
}

skinparam enum {
    BackgroundColor #FFF3E0
    BorderColor #E65100
    HeaderBackgroundColor #F57C00
    FontColor #212121
    HeaderFontColor #FFFFFF
    FontSize 11
}

skinparam package {
    BackgroundColor #FFE0B2
    BorderColor #BF360C
    FontColor #37474F
    FontSize 13
}

skinparam note {
    BackgroundColor #FFFDE7
    BorderColor #F9A825
    FontSize 10
    FontName JetBrains Mono
}

title ink.py.model — Python Proto-Generated Class Diagram\n16 _pb2.py files | 70 messages | 20 enums | protoc v5.28.3 + google.protobuf runtime
footer ink.py.model | proto3 | protoc --python_out --pyi_out | proto-gen.sh sed post-processing | snake_case fields

' ===============================================================
' STORY (story_pb2.py) — 4 messages
' ===============================================================

package "story_pb2.py" #E3F2FD {

    class Choice <<(P,#FF8F00) PY>> {
        + index : int
        + text : str
        + tags : RepeatedScalar[str]
    }

    class StoryState <<(P,#FF8F00) PY>> {
        + text : str
        + can_continue : bool
        + choices : RepeatedComposite[Choice]
        + tags : RepeatedScalar[str]
    }

    class CompileResult <<(P,#FF8F00) PY>> {
        + success : bool
        + json : str
        + errors : RepeatedScalar[str]
        + warnings : RepeatedScalar[str]
    }

    class StorySession <<(P,#FF8F00) PY>> {
        + id : str
        + source : str
        + state_json : str
    }

    StoryState --> "*" Choice : choices
}

' ===============================================================
' STRUCTURE (structure_pb2.py) — 3 enums + 5 messages
' ===============================================================

package "structure_pb2.py" #E8F5E9 {

    enum SectionType <<enum>> {
        SECTION_TYPE_UNSPECIFIED = 0
        KNOT = 1
        STITCH = 2
        FUNCTION = 3
        PREAMBLE = 4
    }

    enum VariableType <<enum>> {
        VARIABLE_TYPE_UNSPECIFIED = 0
        VAR = 1
        CONST = 2
        LIST = 3
        TEMP = 4
    }

    enum DiagramMode <<enum>> {
        DIAGRAM_MODE_UNSPECIFIED = 0
        ACTIVITY = 1
        STATE = 2
    }

    class Section <<(P,#FF8F00) PY>> {
        + name : str
        + type : SectionType
        + start_line : int
        + end_line : int
        + content : str
        + parent : str
        + parameters : RepeatedScalar[str]
        + line_count : int
    }

    class Variable <<(P,#FF8F00) PY>> {
        + name : str
        + type : VariableType
        + initial_value : str
        + line : int
    }

    class DivertRef <<(P,#FF8F00) PY>> {
        + target : str
        + line : int
        + column : int
    }

    class Structure <<(P,#FF8F00) PY>> {
        + sections : RepeatedComposite[Section]
        + variables : RepeatedComposite[Variable]
        + includes : RepeatedScalar[str]
        + diverts : RepeatedComposite[DivertRef]
        + total_lines : int
        + divert_count : int
    }

    class InkDiagramChoice <<(P,#FF8F00) PY>> {
        + text : str
        + divert : str
        + is_sticky_choice : bool
    }

    Section --> SectionType : type
    Variable --> VariableType : type
    Structure --> "*" Section : sections
    Structure --> "*" Variable : variables
    Structure --> "*" DivertRef : diverts
}

' ===============================================================
' TABLE (table_pb2.py) — 1 enum + 3 messages
' ===============================================================

package "table_pb2.py" #FFF3E0 {

    enum CellType <<enum>> {
        STRING = 0
        INT = 1
        FLOAT = 2
        BOOL = 3
        FORMULA = 4
        EMOJI = 5
        FAKER = 6
    }

    class MdCell <<(P,#FF8F00) PY>> {
        + value : str
        + formula : str
        + evaluated : str
        + type : CellType
    }

    class MdRow <<(P,#FF8F00) PY>> {
        + cells : MessageMap[str, MdCell]
    }

    class MdTable <<(P,#FF8F00) PY>> {
        + name : str
        + columns : RepeatedScalar[str]
        + rows : RepeatedComposite[MdRow]
    }

    MdCell --> CellType : type
    MdRow --> "*" MdCell : cells (map)
    MdTable --> "*" MdRow : rows
}

' ===============================================================
' DOCUMENT (document_pb2.py) — 1 enum + 2 messages
'   imports table_pb2
' ===============================================================

package "document_pb2.py" #F3E5F5 {

    enum EditorMode <<enum>> {
        EDITOR_MODE_UNSPECIFIED = 0
        EDIT = 1
        PLAY = 2
    }

    class InkFile <<(P,#FF8F00) PY>> {
        + name : str
        + ink_source : str
        + header_level : int
    }

    class ParseResult <<(P,#FF8F00) PY>> {
        + files : RepeatedComposite[InkFile]
        + tables : RepeatedComposite[MdTable]
    }

    ParseResult --> "*" InkFile : files
    ParseResult --> "*" MdTable : tables
}

' ===============================================================
' ASSET (asset_pb2.py) — 3 messages
' ===============================================================

package "asset_pb2.py" #B2DFDB {

    class AssetCategory <<(P,#FF8F00) PY>> {
        + emoji : str
        + name : str
        + type : str
        + anim_set : str
        + grip_type : str
        + mesh_prefix : str
        + audio_category : str
        + unicode_group : str
        + unicode_subgroup : str
        + code_points : RepeatedScalar[int]
        + unicode_version : str
        + general_category : str
        + is_game_asset : bool
    }

    class VoiceRef <<(P,#FF8F00) PY>> {
        + character_id : str
        + language : str
        + flac_path : str
    }

    class AssetRef <<(P,#FF8F00) PY>> {
        + emoji : str
        + category : AssetCategory
        + mesh_path : str
        + anim_set_id : str
        + voice_ref : VoiceRef
        + metadata : ScalarMap[str, str]
    }

    AssetRef --> AssetCategory : category
    AssetRef --> VoiceRef : voice_ref
}

' ===============================================================
' FAKER (faker_pb2.py) — 2 messages
' ===============================================================

package "faker_pb2.py" #FFECB3 {

    class FakerConfig <<(P,#FF8F00) PY>> {
        + seed : int
        + locale : str
        + count : int
        + level : int
        + categories : RepeatedScalar[str]
    }

    class EmojiCategory <<(P,#FF8F00) PY>> {
        + emoji : str
        + faker_provider : str
        + method_chain : str
        + range_min : int
        + range_max : int
    }
}

' ===============================================================
' EVENT (event_pb2.py) — 2 enums + 5 messages
'   imports asset_pb2
' ===============================================================

package "event_pb2.py" #FFCCBC {

    enum InventoryAction <<enum>> {
        INVENTORY_ACTION_UNSPECIFIED = 0
        EQUIP = 1
        UNEQUIP = 2
        ADD = 3
        REMOVE = 4
        USE = 5
        DROP = 6
    }

    enum LoadPriority <<enum>> {
        LOAD_PRIORITY_UNSPECIFIED = 0
        IMMEDIATE = 1
        PRELOAD = 2
        LAZY = 3
    }

    class AssetEvent <<(P,#FF8F00) PY>> {
        + session_id : str
        + event_type : str
        + asset : AssetRef
        + timestamp : int
    }

    class InventoryChangeEvent <<(P,#FF8F00) PY>> {
        + session_id : str
        + action : str
        + emoji : str
        + asset : AssetRef
        + timestamp : int
        + item_name : str
    }

    class InkTagEvent <<(P,#FF8F00) PY>> {
        + session_id : str
        + tags : RepeatedScalar[str]
        + knot : str
        + timestamp : int
        + resolved_assets : RepeatedComposite[AssetRef]
    }

    class AssetLoadRequest <<(P,#FF8F00) PY>> {
        + session_id : str
        + asset : AssetRef
        + priority : str
        + timestamp : int
    }

    class VoiceSynthRequest <<(P,#FF8F00) PY>> {
        + session_id : str
        + text : str
        + voice_ref : VoiceRef
        + language : str
        + timestamp : int
    }

    AssetEvent --> AssetRef : asset
    InventoryChangeEvent --> AssetRef : asset
    InkTagEvent --> "*" AssetRef : resolved_assets
    AssetLoadRequest --> AssetRef : asset
    VoiceSynthRequest --> VoiceRef : voice_ref
}

' ===============================================================
' DEBUG (debug_pb2.py) — 6 messages
'   imports story_pb2
' ===============================================================

package "debug_pb2.py" #E1F5FE {

    class Breakpoint <<(P,#FF8F00) PY>> {
        + id : str
        + type : str
        + target : str
        + enabled : bool
    }

    class WatchVariable <<(P,#FF8F00) PY>> {
        + name : str
        + last_value : str
        + change_count : int
    }

    class VisitEntry <<(P,#FF8F00) PY>> {
        + step : int
        + text : str
        + choices_made : int
        + variables_changed : RepeatedScalar[str]
        + timestamp : int
    }

    class DebugSession <<(P,#FF8F00) PY>> {
        + session_id : str
        + breakpoints : RepeatedComposite[Breakpoint]
        + watches : MessageMap[str, WatchVariable]
        + visit_log : RepeatedComposite[VisitEntry]
        + stepping : bool
        + step_count : int
        + total_steps : int
        + is_paused : bool
        + last_output : str
    }

    class WatchChange <<(P,#FF8F00) PY>> {
        + old_value : str
        + new_value : str
    }

    class StepResult <<(P,#FF8F00) PY>> {
        + text : str
        + can_continue : bool
        + choices : RepeatedComposite[Choice]
        + tags : RepeatedScalar[str]
        + hit_breakpoint : Breakpoint
        + watch_changes : MessageMap[str, WatchChange]
        + step_number : int
        + is_paused : bool
    }

    DebugSession --> "*" Breakpoint : breakpoints
    DebugSession --> "*" WatchVariable : watches (map)
    DebugSession --> "*" VisitEntry : visit_log
    StepResult --> "*" Choice : choices
    StepResult --> Breakpoint : hit_breakpoint
    StepResult --> "*" WatchChange : watch_changes (map)
}

' ===============================================================
' MCP (mcp_pb2.py) — 11 messages
' ===============================================================

package "mcp_pb2.py" #F3E5F5 {

    class JsonRpcRequest <<(P,#FF8F00) PY>> {
        + jsonrpc : str
        + id : str
        + method : str
        + params_json : str
    }

    class JsonRpcResponse <<(P,#FF8F00) PY>> {
        + jsonrpc : str
        + id : str
        + result_json : str
        + error : JsonRpcError
    }

    class JsonRpcError <<(P,#FF8F00) PY>> {
        + code : int
        + message : str
        + data_json : str
    }

    class McpServerInfo <<(P,#FF8F00) PY>> {
        + name : str
        + version : str
    }

    class McpCapabilities <<(P,#FF8F00) PY>> {
        + tools : McpToolCapability
    }

    class McpToolCapability <<(P,#FF8F00) PY>> {
        + list_changed : bool
    }

    class McpInitializeResult <<(P,#FF8F00) PY>> {
        + protocol_version : str
        + capabilities : McpCapabilities
        + server_info : McpServerInfo
    }

    class McpToolInfo <<(P,#FF8F00) PY>> {
        + name : str
        + description : str
        + input_schema_json : str
    }

    class McpToolsListResult <<(P,#FF8F00) PY>> {
        + tools : RepeatedComposite[McpToolInfo]
    }

    class McpContentBlock <<(P,#FF8F00) PY>> {
        + type : str
        + text : str
    }

    class McpToolResult <<(P,#FF8F00) PY>> {
        + content : RepeatedComposite[McpContentBlock]
        + is_error : bool
    }

    JsonRpcResponse --> JsonRpcError : error
    McpInitializeResult --> McpCapabilities : capabilities
    McpInitializeResult --> McpServerInfo : server_info
    McpCapabilities --> McpToolCapability : tools
    McpToolsListResult --> "*" McpToolInfo : tools
    McpToolResult --> "*" McpContentBlock : content
}

' ===============================================================
' LLM (llm_pb2.py) — 2 messages
' ===============================================================

package "llm_pb2.py" #E0F7FA {

    class GgufModel <<(P,#FF8F00) PY>> {
        + id : str
        + hugging_face_repo : str
        + file_name : str
        + parameters : str
        + quantization : str
        + architecture : str
        + size_gb : float
        + min_vram_gb : int
        + jlama_compatible : bool
        + description : str
    }

    class ServiceDef <<(P,#FF8F00) PY>> {
        + id : str
        + name : str
        + base_url : str
        + default_model : str
        + api_key_env : str
        + description : str
        + requires_api_key : bool
        + is_local : bool
        + doc_url : str
    }
}

' ===============================================================
' PRINCIPAL (principal_pb2.py) — 2 messages
' ===============================================================

package "principal_pb2.py" #FCE4EC {

    class InkPrincipal <<(P,#FF8F00) PY>> {
        + id : str
        + name : str
        + roles : RepeatedScalar[str]
        + is_llm : bool
        + email : str
    }

    class InkPrincipalInfo <<(P,#FF8F00) PY>> {
        + id : str
        + display_name : str
        + email : str
        + role : str
        + is_llm : bool
        + folder_path : str
        + mcp_uri : str
    }
}

' ===============================================================
' CALENDAR (calendar_pb2.py) — 1 message
' ===============================================================

package "calendar_pb2.py" #F1F8E9 {

    class InkEvent <<(P,#FF8F00) PY>> {
        + uid : str
        + summary : str
        + description : str
        + dt_start : str
        + dt_end : str
        + category : str
        + location : str
        + status : str
    }
}

' ===============================================================
' COLLAB (collab_pb2.py) — 3 messages
' ===============================================================

package "collab_pb2.py" #EDE7F6 {

    class ColabClient <<(P,#FF8F00) PY>> {
        + client_id : str
        + doc_id : str
    }

    class ColabDocumentInfo <<(P,#FF8F00) PY>> {
        + doc_id : str
        + created_at : int
        + update_count : int
        + client_count : int
    }

    class EditorContext <<(P,#FF8F00) PY>> {
        + mode : str
        + session_id : str
        + doc_id : str
        + is_compiling : bool
        + errors : RepeatedScalar[str]
    }
}

' ===============================================================
' SILLYTAVERN (sillytavern_pb2.py) — 1 message
' ===============================================================

package "sillytavern_pb2.py" #FFF9C4 {

    class StCharacterCard <<(P,#FF8F00) PY>> {
        + name : str
        + description : str
        + personality : str
        + scenario : str
        + first_message : str
        + mes_example : str
        + system_prompt : str
        + creator_notes : str
        + tags : RepeatedScalar[str]
    }
}

' ===============================================================
' ICAL (ical_pb2.py) — 9 enums + 11 messages
' ===============================================================

package "ical_pb2.py" #DCEDC8 {

    enum EventStatus <<enum>> {
        EVENT_STATUS_UNSPECIFIED = 0
        TENTATIVE = 1
        CONFIRMED = 2
        CANCELLED = 3
    }

    enum TodoStatus <<enum>> {
        TODO_STATUS_UNSPECIFIED = 0
        NEEDS_ACTION = 1
        COMPLETED = 2
        IN_PROCESS = 3
        TODO_CANCELLED = 4
    }

    enum ParticipationStatus <<enum>> {
        PARTSTAT_UNSPECIFIED = 0
        ACCEPTED = 1
        DECLINED = 2
        ..
    }

    enum ParticipantRole <<enum>> {
        ROLE_UNSPECIFIED = 0
        CHAIR = 1
        REQ_PARTICIPANT = 2
        OPT_PARTICIPANT = 3
        NON_PARTICIPANT = 4
    }

    enum RecurrenceFrequency <<enum>> {
        FREQ_UNSPECIFIED = 0
        SECONDLY = 1
        ..
        YEARLY = 7
    }

    enum Weekday <<enum>> {
        WEEKDAY_UNSPECIFIED = 0
        MO = 1
        TU = 2
        ..
        SU = 7
    }

    enum AlarmAction <<enum>> {
        ALARM_ACTION_UNSPECIFIED = 0
        DISPLAY = 1
        AUDIO = 2
        EMAIL = 3
    }

    enum Transparency <<enum>> {
        TRANSP_UNSPECIFIED = 0
        OPAQUE = 1
        TRANSPARENT = 2
    }

    enum AccessClassification <<enum>> {
        CLASS_UNSPECIFIED = 0
        PUBLIC = 1
        PRIVATE = 2
        CONFIDENTIAL = 3
    }

    class WeekdayNum <<(P,#FF8F00) PY>> {
        + ordinal : int
        + day : Weekday
    }

    class RecurrenceRule <<(P,#FF8F00) PY>> {
        + freq : RecurrenceFrequency
        + interval : int
        + count : int
        + until : str
        + by_day : RepeatedComposite[WeekdayNum]
        + by_month_day : RepeatedScalar[int]
        + by_year_day : RepeatedScalar[int]
        + by_week_no : RepeatedScalar[int]
        + by_month : RepeatedScalar[int]
        + by_set_pos : RepeatedScalar[int]
        + week_start : Weekday
        + by_hour : RepeatedScalar[int]
        + by_minute : RepeatedScalar[int]
        + by_second : RepeatedScalar[int]
    }

    class Attendee <<(P,#FF8F00) PY>> {
        + cal_address : str
        + common_name : str
        + role : ParticipantRole
        + partstat : ParticipationStatus
        + rsvp : bool
        + delegated_from : str
        + delegated_to : str
        + sent_by : str
    }

    class Organizer <<(P,#FF8F00) PY>> {
        + cal_address : str
        + common_name : str
        + sent_by : str
    }

    class Alarm <<(P,#FF8F00) PY>> {
        + action : AlarmAction
        + trigger : str
        + trigger_absolute : bool
        + description : str
        + summary : str
        + repeat_count : int
        + repeat_duration : str
    }

    class ICalDuration <<(P,#FF8F00) PY>> {
        + negative : bool
        + weeks : int
        + days : int
        + hours : int
        + minutes : int
        + seconds : int
    }

    class GeoPosition <<(P,#FF8F00) PY>> {
        + latitude : float
        + longitude : float
    }

    class VEvent <<(P,#FF8F00) PY>> {
        + uid : str
        + sequence : int
        + dt_start : str
        + dt_end : str
        + duration : ICalDuration
        + dt_stamp : str
        + summary : str
        + description : str
        + location : str
        + geo : GeoPosition
        + url : str
        + status : EventStatus
        + classification : AccessClassification
        + transp : Transparency
        + priority : int
        + categories : RepeatedScalar[str]
        + resources : RepeatedScalar[str]
        + organizer : Organizer
        + attendees : RepeatedComposite[Attendee]
        + rrule : RecurrenceRule
        .. rdate, exdate, recurrence_id ..
        + alarms : RepeatedComposite[Alarm]
        + created : str
        + last_modified : str
        .. related_to, attachments, color, conferences ..
    }

    class VTodo <<(P,#FF8F00) PY>> {
        + uid : str
        + sequence : int
        + dt_start : str
        + due : str
        + duration : ICalDuration
        + completed : str
        + summary : str
        + description : str
        + location : str
        + status : TodoStatus
        + classification : AccessClassification
        + priority : int
        + percent_complete : int
        .. categories, organizer, attendees ..
        + rrule : RecurrenceRule
        + alarms : RepeatedComposite[Alarm]
        .. created, last_modified, related_to ..
    }

    class VJournal <<(P,#FF8F00) PY>> {
        + uid : str
        + sequence : int
        + dt_start : str
        + summary : str
        + description : str
        + status : EventStatus
        + classification : AccessClassification
        .. categories, organizer, attendees ..
        + rrule : RecurrenceRule
        .. created, last_modified, related_to ..
    }

    class VCalendar <<(P,#FF8F00) PY>> {
        + prod_id : str
        + version : str
        + cal_scale : str
        + method : str
        + name : str
        + description : str
        + color : str
        + source : str
        + refresh_interval : str
        + events : RepeatedComposite[VEvent]
        + todos : RepeatedComposite[VTodo]
        + journals : RepeatedComposite[VJournal]
    }

    WeekdayNum --> Weekday : day
    RecurrenceRule --> RecurrenceFrequency : freq
    RecurrenceRule --> "*" WeekdayNum : by_day
    RecurrenceRule --> Weekday : week_start
    Attendee --> ParticipantRole : role
    Attendee --> ParticipationStatus : partstat
    Alarm --> AlarmAction : action
    VEvent --> ICalDuration : duration
    VEvent --> GeoPosition : geo
    VEvent --> EventStatus : status
    VEvent --> Organizer : organizer
    VEvent --> "*" Attendee : attendees
    VEvent --> RecurrenceRule : rrule
    VEvent --> "*" Alarm : alarms
    VTodo --> TodoStatus : status
    VTodo --> ICalDuration : duration
    VTodo --> RecurrenceRule : rrule
    VTodo --> "*" Alarm : alarms
    VJournal --> EventStatus : status
    VJournal --> RecurrenceRule : rrule
    VCalendar --> "*" VEvent : events
    VCalendar --> "*" VTodo : todos
    VCalendar --> "*" VJournal : journals
}

' ===============================================================
' VCARD (vcard_pb2.py) — 4 enums + 9 messages
' ===============================================================

package "vcard_pb2.py" #F0F4C3 {

    enum VCardVersion <<enum>> {
        VCARD_VERSION_UNSPECIFIED = 0
        V3_0 = 1
        V4_0 = 2
    }

    enum TelType <<enum>> {
        TEL_TYPE_UNSPECIFIED = 0
        VOICE = 1
        TEXT = 2
        FAX = 3
        CELL = 4
        VIDEO = 5
        PAGER = 6
    }

    enum AdrType <<enum>> {
        ADR_TYPE_UNSPECIFIED = 0
        HOME = 1
        WORK = 2
    }

    enum EmailType <<enum>> {
        EMAIL_TYPE_UNSPECIFIED = 0
        EMAIL_HOME = 1
        EMAIL_WORK = 2
    }

    class VCardName <<(P,#FF8F00) PY>> {
        + family : str
        + given : str
        + additional : str
        + prefix : str
        + suffix : str
    }

    class VCardAddress <<(P,#FF8F00) PY>> {
        + type : AdrType
        + po_box : str
        + extended : str
        + street : str
        + locality : str
        + region : str
        + postal_code : str
        + country : str
        + label : str
    }

    class VCardTelephone <<(P,#FF8F00) PY>> {
        + type : TelType
        + value : str
        + is_preferred : bool
    }

    class VCardEmail <<(P,#FF8F00) PY>> {
        + type : EmailType
        + value : str
        + is_preferred : bool
    }

    class VCardOrganization <<(P,#FF8F00) PY>> {
        + name : str
        + unit : str
    }

    class VCardImage <<(P,#FF8F00) PY>> {
        + uri : str
        + media_type : str
        + data : bytes
    }

    class VCardExtProperty <<(P,#FF8F00) PY>> {
        + name : str
        + value : str
    }

    class InkVCard <<(P,#FF8F00) PY>> {
        + uid : str
        + version : VCardVersion
        + formatted_name : str
        + name : VCardName
        + emails : RepeatedComposite[VCardEmail]
        + telephones : RepeatedComposite[VCardTelephone]
        + addresses : RepeatedComposite[VCardAddress]
        + org : VCardOrganization
        + title : str
        + role : str
        + photo : VCardImage
        + logo : VCardImage
        + urls : RepeatedScalar[str]
        + categories : RepeatedScalar[str]
        + note : str
        .. key, rev, is_llm, roles ..
        .. folder_path, mcp_uri, jcard_json ..
        + ext_properties : RepeatedComposite[VCardExtProperty]
        + language : str
        + timezone : str
    }

    class JCard <<(P,#FF8F00) PY>> {
        + json : str
        + parsed : InkVCard
    }

    VCardAddress --> AdrType : type
    VCardTelephone --> TelType : type
    VCardEmail --> EmailType : type
    InkVCard --> VCardVersion : version
    InkVCard --> VCardName : name
    InkVCard --> "*" VCardEmail : emails
    InkVCard --> "*" VCardTelephone : telephones
    InkVCard --> "*" VCardAddress : addresses
    InkVCard --> VCardOrganization : org
    InkVCard --> VCardImage : photo
    InkVCard --> VCardImage : logo
    InkVCard --> "*" VCardExtProperty : ext_properties
    JCard --> InkVCard : parsed
}

' ===============================================================
' CROSS-FILE DEPENDENCIES (_pb2.py imports)
' ===============================================================

' document_pb2.py imports table_pb2
ParseResult ..> MdTable : <<import>>\ntable_pb2

' event_pb2.py imports asset_pb2
AssetEvent ..> AssetRef : <<import>>\nasset_pb2
InventoryChangeEvent ..> AssetRef : <<import>>\nasset_pb2
InkTagEvent ..> AssetRef : <<import>>\nasset_pb2
AssetLoadRequest ..> AssetRef : <<import>>\nasset_pb2
VoiceSynthRequest ..> VoiceRef : <<import>>\nasset_pb2

' debug_pb2.py imports story_pb2
StepResult ..> Choice : <<import>>\nstory_pb2

' ===============================================================
' NOTES
' ===============================================================

note as N1
  **ink.py.model — Python Protobuf Generation (2026-03-01)**
  ================================================================

  **Generator**: protoc v5.28.3 via proto-gen.sh
  **Runtime**: google.protobuf v5.28.3

  **Generation pipeline (proto-gen.sh py target):**
  1. protoc --python_out=TMP --pyi_out=TMP *.proto
  2. sed post-processing on each generated file:
     sed 's/ink\.model/ink.py.model/g'
     sed 's/ink_dot_model/ink_dot_py_dot_model/g'
  3. Copy to src/pyMain/ink/py/model/
  4. Create __init__.py at ink/, ink/py/, ink/py/model/

  **Runtime pattern (every _pb2.py):**
  | Step | Code |
  | 1 | DESCRIPTOR = descriptor_pool.AddSerializedFile(b'...') |
  | 2 | BuildMessageAndEnumDescriptors(DESCRIPTOR, globals()) |
  | 3 | BuildTopDescriptorsAndMessages(DESCRIPTOR, module, globals()) |

  **Python-specific behavior:**
  - Message classes: google.protobuf.message.Message subclasses
  - Enum classes: int + EnumTypeWrapper metaclass
  - Field names: snake_case directly from proto (no conversion)
  - Type stubs: .pyi files for mypy/pyright type checking
  - Map fields: MessageMap[K, V] / ScalarMap[K, V]
  - Repeated fields: RepeatedCompositeFieldContainer / RepeatedScalarFieldContainer

  **16 _pb2.py + 16 .pyi files | 70 messages | 20 enums**
end note

note as N2
  **Cross-Language Protobuf Codegen Stack**
  ================================================================

  | Language | Tool | Output Package | Wire |
  | KT/KMP | Wire Gradle plugin | ink.model | proto3 |
  | Python | protoc --python_out | ink.py.model | proto3 |
  | TypeScript | protoc-gen-ts_proto | ink.ts.model | JSON |
  | C# | protoc --csharp_out | Ink.Cs.Model | proto3 |

  **proto-gen.sh** manages PY, TS, CS targets
  **Wire Gradle plugin** manages KT target (./gradlew generateProtos)

  **Interop stack (current + planned):**
  - KT <-> PY: protobuf binary / JSON serialization
  - KT <-> TS: ts-proto JSON methods
  - KT <-> CS: protobuf binary (C# namespace via proto option)
  - CS <-> Unity: MagicOnion (planned gRPC for Unity)

  **All 4 language bindings share identical proto3 schemas.**
  **Single source of truth: src/proto/ink/model/*.proto**
end note

note as N_PROGRESS
  **Progress: 16 / 16 _pb2.py generated**
  ================================================================

  | # | Module | Msgs | Enums | Status |
  | 1 | story_pb2.py | 4 | 0 | done |
  | 2 | structure_pb2.py | 5 | 3 | done |
  | 3 | table_pb2.py | 3 | 1 | done |
  | 4 | document_pb2.py | 2 | 1 | done |
  | 5 | asset_pb2.py | 3 | 0 | done |
  | 6 | faker_pb2.py | 2 | 0 | done |
  | 7 | event_pb2.py | 5 | 2 | done |
  | 8 | debug_pb2.py | 6 | 0 | done |
  | 9 | mcp_pb2.py | 11 | 0 | done |
  | 10 | llm_pb2.py | 2 | 0 | done |
  | 11 | principal_pb2.py | 2 | 0 | done |
  | 12 | calendar_pb2.py | 1 | 0 | done |
  | 13 | collab_pb2.py | 3 | 0 | done |
  | 14 | sillytavern_pb2.py | 1 | 0 | done |
  | 15 | ical_pb2.py | 11 | 9 | done |
  | 16 | vcard_pb2.py | 9 | 4 | done |
  |    | **Total** | **70** | **20** | **all** |

  Cross-file imports: 3 (document->table, event->asset, debug->story)
end note

N1 .. StoryState
N2 .. CompileResult
N_PROGRESS .. McpServerInfo

' ===============================================================
' LEGEND
' ===============================================================

legend bottom right
  |= Color |= _pb2.py Module Domain |
  | <#E3F2FD> | story — narrative state |
  | <#E8F5E9> | structure — ink document |
  | <#FFF3E0> | table — MD data tables |
  | <#F3E5F5> | document / mcp — file + protocol |
  | <#B2DFDB> | asset — emoji/mesh/anim |
  | <#FFECB3> | faker — data generation |
  | <#FFCCBC> | event — RSocket events |
  | <#E1F5FE> | debug — breakpoints/watch |
  | <#E0F7FA> | llm — model definitions |
  | <#FCE4EC> | principal — auth/identity |
  | <#F1F8E9> | calendar — iCal events |
  | <#EDE7F6> | collab — Yjs sessions |
  | <#FFF9C4> | sillytavern — character cards |
  | <#DCEDC8> | ical — RFC 5545 calendar |
  | <#F0F4C3> | vcard — RFC 6350 contacts |
  |= Stereotype |= Meaning |
  | <<(P,#FF8F00) PY>> | Python Message class (google.protobuf.message.Message) |
  | <<enum>> | Python Enum (int + EnumTypeWrapper) |
endlegend

@enduml
