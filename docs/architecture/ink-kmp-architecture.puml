@startuml ink-kmp-architecture
!theme plain
skinparam backgroundColor #FEFEFE
skinparam packageStyle rectangle
skinparam componentStyle rectangle

title Ink Ecosystem — Multi-Protocol Architecture\n(KMP commonMain: 31 classes ported from C#/Java/JS)
footer MCP • Yjs Collab • RSocket EDA • KMP Runtime (31 classes) • ACE • CodeMirror • Remirror • BabylonJS WebXR • Unity WebGL

' ───────── Color palette ─────────
skinparam component {
    BackgroundColor<<js>> #E8F5E9
    BackgroundColor<<kt>> #E3F2FD
    BackgroundColor<<rs>> #FFF3E0
    BackgroundColor<<cs>> #F3E5F5
    BackgroundColor<<mcp>> #FFEBEE
    BackgroundColor<<kmp>> #E0F7FA
    BackgroundColor<<eda>> #B2DFDB
    BackgroundColor<<collab>> #F3E5F5
}

' ───────── Top: Ink Language ─────────
package "Ink Language (inkle)" as ink {
    [ink syntax\n.ink files] as INK
    [inklecate\n(C# compiler)] as INKLECATE <<cs>>
    [ink JSON\nformat] as INKJSON
    INK --> INKLECATE
    INKLECATE --> INKJSON
}

' ───────── Shared Grammar ─────────
package "@inky/ink-language\n(shared grammar)" as grammar {
    [ink-grammar.ts] as GRAMMAR
    [ink-keywords.ts] as KEYWORDS
}

' ───────── JS Editor Ecosystem ─────────
package "JavaScript Editor Ecosystem" as jseco {
    package "Inky Desktop (Electron)" as elApp <<js>> {
        [ACE Editor\n+ ace-ink-mode] as ACE <<js>>
        [inklecate subprocess\n+ inkjs runtime] as EL_RUNTIME <<js>>
    }

    package "inkey Web (PWA)" as inkeyApp <<kmp>> {
        [CodeMirror 6\n(@inky/codemirror-ink)] as CM6 <<kmp>>
        [Remirror\n(@inky/remirror-ink)\nMD + ```ink blocks] as REMIRROR <<kmp>>
        [InkPlayer.tsx\n(play mode)] as PLAYER <<kmp>>
        [ModeToggle\n(edit ↔ play)] as TOGGLE <<kmp>>
    }

    [inkjs\n(JS compiler+runtime)] as INKJS <<js>>
    [bidify.js\n(RTL bidi markers)] as BIDIFY <<js>>

    INKJS --> EL_RUNTIME : used by
    INKJS --> PLAYER : used by
    BIDIFY --> EL_RUNTIME : used by
}

' ───────── JVM/KMP Ecosystem ─────────
package "JVM / KMP Ecosystem" as jvmeco {
    package "blade-ink-java\n(bladecoder)" as bladejava <<kt>> {
        [Story.java\n(runtime)] as BIR
        [Compiler.java\n(compiler)] as BIC
        [Choice.java] as BICHOICE
    }

    package "blade-ink-rs\n(Rust + FFI)" as bladers <<rs>> {
        [ink runtime\n(Rust)] as BIRS
        [C FFI\nbindings] as BIRSFFI
        BIRS --> BIRSFFI
    }

    package "Inky MCP Server\n(Ktor + GraalJS)" as mcpserver <<mcp>> {
        [InkEngine.kt\n(GraalJS ≈ OneJS)] as ENGINE
        [McpTools.kt\n(79 tools)] as TOOLS
        [McpRouter.kt\n(SSE + RSocket)] as ROUTER
        [InkAssetEventEngine\n+ EmojiAssetManifest] as ASSET <<eda>>
        [AssetEventBus\n(RSocket + msgpack)] as BUS <<eda>>
        [ColabEngine\n(Yjs HocusPocus)] as COLAB <<collab>>
        ENGINE --> TOOLS
        TOOLS --> ROUTER
        TOOLS --> ASSET
        ASSET --> BUS
        ENGINE --> COLAB
    }
}

' ───────── C# / Unity ─────────
package "C# / Unity" as cseco {
    package "ink-csharp\n(native runtime)" as csink <<cs>> {
        [Ink.Compiler] as CS_COMP <<cs>>
        [Ink.Runtime.Story] as CS_STORY <<cs>>
    }

    package "OneJS Bridge\n(JS ↔ C#)" as onejs <<cs>> {
        [InkOneJsBinding.cs\n(11 methods)] as ONEJS <<cs>>
        [InkAssetEventReceiver.cs] as CS_RECEIVER <<cs>>
    }

    ONEJS --> CS_COMP : uses
    ONEJS --> CS_STORY : manages
}

' ───────── KMP commonMain Runtime (31 classes ported) ─────────
package "ink-kmp-mcp/commonMain\n(31 classes — C#/Java/JS three-way port)" as kmpRuntime <<kmp>> {
    [InkObject → Container\nValue<T> (sealed)\nGlue, Void, Tag, Divert\nChoicePoint, ControlCommand\nVariableAssignment/Reference] as KMP_CORE <<kmp>>
    [CallStack + Element + Thread\nFlow, StatePatch\nVariablesState (fun interface)\nNativeFunctionCall (fun interface)] as KMP_ENGINE <<kmp>>
    [StoryState\n(OutputOp functional enum)\n(LinkedHashMap state)\n(TreeMap<Choice>)] as KMP_STATE <<kmp>>
    [InkList (LinkedHashMap delegation)\nListDefinition (lazy items)\nListDefinitionsOrigin\nInkListItem (data class)] as KMP_LIST <<kmp>>
    KMP_CORE --> KMP_ENGINE
    KMP_ENGINE --> KMP_STATE
    KMP_CORE --> KMP_LIST
}

' ───────── KMP Target Layer ─────────
package "KMP Targets" as kmp <<kmp>> {
    [JVM\n(Android, Desktop)] as KMP_JVM
    [JS\n(Browser, Node)] as KMP_JS
    [Native\n(iOS, Linux, macOS)] as KMP_NATIVE
    [WASM\n(WasmJS, WASI)] as KMP_WASM
}

kmpRuntime --> kmp : compiled to

' ───────── Client Surfaces ─────────
package "Client Surfaces" as consumers {
    [SillyTavern\n(MCP user UI)] as SILLYTAVERN
    [LLM / AI Agent\n(Claude, GPT)] as LLM
    [inkey Editor\n(PWA)] as INKEY_PWA
    [Chromium PWA\nExtension] as CHROME_EXT
    [BabylonJS\n(WebXR / glTF)] as BABYLON
    [Unity\n(WebGL / AssetBundles)] as UNITY
    [Game Engine\n(LibGDX, Godot)] as GAME
}

' ───────── Protocol Layer ─────────
package "Protocols" as protocols {
    [MCP\n(SSE/stdio/REST)\nJSON-RPC] as PROTO_MCP <<mcp>>
    [Yjs\n(HocusPocus WS)\nCRDT sync] as PROTO_YJS <<collab>>
    [RSocket\n(WS + msgpack)\nEDA events] as PROTO_RSOCKET <<eda>>
    [OneJS\n(__inkBridge)\nin-process] as PROTO_ONEJS <<cs>>
}

' ───────── Connections ─────────
INKJS ..> ENGINE : loaded via\nGraalJS
BIDIFY ..> ENGINE : loaded via\nGraalJS
INK --> INKJS : compiles
INK --> BIC : compiles
INK --> CS_COMP : compiles

GRAMMAR --> ACE : syntax
GRAMMAR --> CM6 : syntax
GRAMMAR --> REMIRROR : syntax

BIR --> KMP_JVM : direct use
BIRS --> KMP_NATIVE : via FFI
INKJS --> KMP_JS : via require()
INKJS --> KMP_WASM : via wasm-bindgen\nor Javy

' KMP runtime connections
KMP_STATE ..> ENGINE : replaces\nStoryState internals
KMP_ENGINE ..> BIR : replaces\nblade-ink internals

' Protocol connections
ROUTER --> PROTO_MCP
PROTO_MCP --> LLM : tool invocation
PROTO_MCP --> SILLYTAVERN : REST/MCP API
COLAB --> PROTO_YJS
PROTO_YJS --> INKEY_PWA : collab sync
PROTO_YJS --> CHROME_EXT : collab sync
BUS --> PROTO_RSOCKET
PROTO_RSOCKET --> BABYLON : asset events\n(WebSocket)
PROTO_RSOCKET --> INKEY_PWA : asset events\n(WebSocket)
PROTO_RSOCKET --> CHROME_EXT : asset events\n(WebSocket)
ONEJS --> PROTO_ONEJS
PROTO_ONEJS --> UNITY : asset events\n(in-process)

KMP_JVM --> GAME : blade-ink API
KMP_JS --> INKEY_PWA : inkjs API
KMP_NATIVE --> GAME : FFI bindings

@enduml
