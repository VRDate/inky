@startuml ink-js-classes
!theme plain
skinparam backgroundColor #FEFEFE
skinparam classAttributeIconSize 0

' â”€â”€ Teal/green theme for JavaScript classes (inkjs) â”€â”€
' Goal: port missing JS to Kotlin/JS with same JS syntax
' Most UI code is pure JS (not TS) â€” inkjs is the reference
skinparam class {
    BackgroundColor #E0F2F1
    BorderColor #00695C
    HeaderBackgroundColor #00897B
    FontColor #212121
    HeaderFontColor #FFFFFF
    StereotypeFontColor #004D40
    AttributeFontColor #37474F
}
skinparam package {
    BackgroundColor #F1F8E9
    BorderColor #33691E
    FontColor #1B5E20
}
skinparam note {
    BackgroundColor #FFF8E1
    BorderColor #F9A825
    FontColor #4E342E
}
skinparam arrow {
    Color #00695C
}

title inkjs â€” TypeScript/JavaScript Ink Runtime Class Diagram\n(npm inkjs â€” JS port of inkle/ink C# runtime)
footer inkjs (y-lohse/inkjs) | npm inkjs | CommonJS + ESM | Story API compatible with C#/Java/Kotlin ports

' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' CORE CLASSES
' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

package "Core" #E0F2F1 {

    class InkObject <<(T,#009688) TS>> {
        +parent: Container | null
        +ownDebugMetadata: DebugMetadata | null
        --
        +{readonly} debugMetadata: DebugMetadata | null
        +{readonly} path: Path
        +{readonly} rootContentContainer: Container | null
        --
        +resolvePath(path: Path): SearchResult
        +convertPathToRelative(globalPath: Path): Path
        +compactPathString(otherPath: Path): string
        +debugLineNumberOfPath(path: Path): number | null
        +copy(): InkObject
    }

    class Container <<(T,#009688) TS>> {
        +name: string | null
        +content: InkObject[]
        +namedContent: Map<string, INamedContent>
        +visitsShouldBeCounted: boolean
        +turnIndexShouldBeCounted: boolean
        +countingAtStartOnly: boolean
        +countFlags: number
        --
        +{readonly} hasValidName: boolean
        +{readonly} namedOnlyContent: Map<string, InkObject>
        --
        +addContent(contentObj: InkObject): void
        +insertContent(contentObj: InkObject, index: number): void
        +addContentsOfContainer(other: Container): void
        +addToNamedContentOnly(named: INamedContent): void
        +contentAtPath(path: Path, partialStart?: number, len?: number): SearchResult
        +buildStringOfHierarchy(): string
    }

    class Path <<(T,#009688) TS>> {
        +isRelative: boolean
        --
        +{readonly} head: Path.Component | null
        +{readonly} tail: Path
        +{readonly} length: number
        +{readonly} lastComponent: Path.Component | null
        +{readonly} componentsString: string
        --
        +getComponent(index: number): Path.Component
        +pathByAppendingPath(path: Path): Path
        +pathByAppendingComponent(c: Path.Component): Path
        +containsNamedComponent(): boolean
        +equals(other: Path): boolean
        +toString(): string
    }

    class "Path.Component" as PathComponent <<(T,#009688) TS>> {
        +index: number
        +name: string | null
        --
        +{readonly} isIndex: boolean
        +{readonly} isParent: boolean
        --
        +toString(): string
        +equals(other: Path.Component): boolean
        +{static} toParent(): Path.Component
    }

    class SearchResult <<(T,#009688) TS>> {
        +obj: InkObject | null
        +approximate: boolean
        --
        +{readonly} correctObj: InkObject | null
        +{readonly} container: Container | null
    }

    class Pointer <<(T,#009688) TS>> {
        +container: Container | null
        +index: number
        --
        +{readonly} isNull: boolean
        +{readonly} path: Path | null
        --
        +resolve(): InkObject | null
        +assign(p: Pointer): void
        +toString(): string
        ..
        +{static} Null: Pointer
        +{static} startOf(container: Container): Pointer
    }

    class DebugMetadata <<(T,#009688) TS>> {
        +startLineNumber: number
        +endLineNumber: number
        +startCharacterNumber: number
        +endCharacterNumber: number
        +fileName: string | null
        +sourceName: string | null
        --
        +merge(dm: DebugMetadata): DebugMetadata
        +toString(): string
    }

    interface INamedContent <<(T,#009688) TS>> {
        +{readonly} name: string | null
        +{readonly} hasValidName: boolean
    }

    Path *-- PathComponent : components
}

' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' CONTENT CLASSES (runtime instructions)
' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

package "Content" #E8F5E9 {

    class ChoicePoint <<(T,#009688) TS>> {
        +onceOnly: boolean
        +hasCondition: boolean
        +hasStartContent: boolean
        +hasChoiceOnlyContent: boolean
        +isInvisibleDefault: boolean
        +flags: number
        --
        +{readonly} choiceTarget: Container
        +pathOnChoice: Path | null
        +pathStringOnChoice: string | null
    }

    class Choice <<(T,#009688) TS>> {
        +text: string | null
        +index: number
        +sourcePath: string | null
        +isInvisibleDefault: boolean
        +originalThreadIndex: number
        +tags: string[] | null
        +threadAtGeneration: CallStack.Thread | null
        --
        +targetPath: Path | null
        +pathStringOnChoice: string | null
    }

    class Divert <<(T,#009688) TS>> {
        +stackPushType: PushPopType
        +pushesToStack: boolean
        +isExternal: boolean
        +externalArgs: number
        +isConditional: boolean
        +variableDivertName: string | null
        --
        +{readonly} hasVariableTarget: boolean
        +targetPath: Path | null
        +{readonly} targetPointer: Pointer
        +targetPathString: string | null
    }

    class Glue <<(T,#009688) TS>> {
        +toString(): string
    }

    class Tag <<(T,#009688) TS>> {
        +{readonly} text: string
        +toString(): string
    }

    class Void <<(T,#009688) TS>> {
    }

    class ControlCommand <<(T,#009688) TS>> {
        +commandType: CommandType
        +copy(): InkObject
        +toString(): string
    }

    enum CommandType <<(T,#009688) TS>> {
        NotSet
        EvalStart
        EvalOutput
        EvalEnd
        Duplicate
        PopEvaluatedValue
        PopFunction
        PopTunnel
        BeginString
        EndString
        NoOp
        ChoiceCount
        Turns
        TurnsSince
        ReadCount
        Random
        SeedRandom
        VisitIndex
        SequenceShuffleIndex
        StartThread
        Done
        End
        ListFromInt
        ListRange
        ListRandom
        BeginTag
        EndTag
    }

    class VariableAssignment <<(T,#009688) TS>> {
        +variableName: string | null
        +isNewDeclaration: boolean
        +isGlobal: boolean
    }

    class VariableReference <<(T,#009688) TS>> {
        +name: string | null
        +pathForCount: Path | null
        --
        +{readonly} containerForCount: Container | null
        +pathStringForCount: string | null
    }

    class NativeFunctionCall <<(T,#009688) TS>> {
        +name: string | null
        +{readonly} numberOfParameters: number
        --
        +call(params: InkObject[]): InkObject | null
        +callBinaryListOperation(params: InkObject[]): Value
        +callListIncrementOperation(listIntParams: InkObject[]): Value
        ..
        +{static} callWithName(functionName: string): NativeFunctionCall
        +{static} callExistsWithName(name: string): boolean
    }

    ControlCommand --> CommandType : uses
}

' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' VALUE CLASSES
' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

package "Values" #E0F7FA {

    enum ValueType <<(T,#009688) TS>> {
        Bool
        Int
        Float
        List
        String
        DivertTarget
        VariablePointer
    }

    abstract class "Value<T>" as Value <<(T,#009688) TS>> {
        +value: T
        --
        +{abstract} {readonly} valueType: ValueType
        +{abstract} {readonly} isTruthy: boolean
        +{abstract} cast(newType: ValueType): Value | null
        --
        +{readonly} valueObject: any
        +copy(): InkObject
        +toString(): string
        ..
        +{static} Create(val: any): Value | null
    }

    class BoolValue <<(T,#009688) TS>> {
        +value: boolean
        --
        +valueType = ValueType.Bool
        +{readonly} isTruthy: boolean
        +cast(newType: ValueType): Value | null
        +toString(): string
    }

    class IntValue <<(T,#009688) TS>> {
        +value: number
        --
        +valueType = ValueType.Int
        +{readonly} isTruthy: boolean
        +cast(newType: ValueType): Value | null
    }

    class FloatValue <<(T,#009688) TS>> {
        +value: number
        --
        +valueType = ValueType.Float
        +{readonly} isTruthy: boolean
        +cast(newType: ValueType): Value | null
    }

    class StringValue <<(T,#009688) TS>> {
        +value: string
        +{readonly} isNewline: boolean
        +{readonly} isInlineWhitespace: boolean
        +{readonly} isNonWhitespace: boolean
        --
        +valueType = ValueType.String
        +{readonly} isTruthy: boolean
        +cast(newType: ValueType): Value | null
    }

    class DivertTargetValue <<(T,#009688) TS>> {
        +targetPath: Path | null
        --
        +valueType = ValueType.DivertTarget
        +{readonly} isTruthy: //throws//
        +cast(newType: ValueType): Value | null
    }

    class VariablePointerValue <<(T,#009688) TS>> {
        +variableName: string | null
        +contextIndex: number
        --
        +valueType = ValueType.VariablePointer
        +{readonly} isTruthy: //throws//
        +cast(newType: ValueType): Value | null
        +copy(): InkObject
    }

    class ListValue <<(T,#009688) TS>> {
        +value: InkList
        --
        +valueType = ValueType.List
        +{readonly} isTruthy: boolean
        +cast(newType: ValueType): Value | null
        ..
        +{static} retainListOriginsForAssignment(old: InkObject, new: InkObject): void
    }

    Value <|-- BoolValue
    Value <|-- IntValue
    Value <|-- FloatValue
    Value <|-- StringValue
    Value <|-- DivertTargetValue
    Value <|-- VariablePointerValue
    Value <|-- ListValue
    Value --> ValueType : uses
}

' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' LIST CLASSES
' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

package "Lists" #F1F8E9 {

    class InkList <<(T,#009688) TS>> {
        +origins: ListDefinition[] | null
        --
        +{readonly} originNames: string[] | null
        +{readonly} maxItem: MapEntry<InkListItem, number>
        +{readonly} minItem: MapEntry<InkListItem, number>
        +{readonly} inverse: InkList
        +{readonly} all: InkList
        +{readonly} originOfMaxItem: ListDefinition | null
        --
        +union(other: InkList): InkList
        +intersect(other: InkList): InkList
        +without(other: InkList): InkList
        +contains(other: InkList): boolean
        +greaterThan(other: InkList): boolean
        +lessThan(other: InkList): boolean
        +maxAsList(): InkList
        +minAsList(): InkList
        +listWithSubRange(min: any, max: any): InkList
        +setInitialOriginName(name: string): void
        +setInitialOriginNames(names: string[]): void
        +equals(other: InkList): boolean
        +toString(): string
    }

    class InkListItem <<(T,#009688) TS>> {
        +{readonly} originName: string | null
        +{readonly} itemName: string | null
        --
        +{readonly} isNull: boolean
        +{readonly} fullName: string
        --
        +toString(): string
        +equals(other: InkListItem): boolean
        ..
        +{static} Null: InkListItem
    }

    class ListDefinition <<(T,#009688) TS>> {
        +{readonly} name: string | null
        +{readonly} items: Map<InkListItem, number>
        --
        +getValueForItem(item: InkListItem): number | null
        +containsItem(item: InkListItem): boolean
        +containsItemWithName(name: string): boolean
        +getItemWithValue(value: number): InkListItem | null
    }

    class ListDefinitionsOrigin <<(T,#009688) TS>> {
        +{readonly} lists: ListDefinition[]
        --
        +getListDefinition(name: string): ListDefinition | null
        +findSingleItemListWithName(name: string): ListValue | null
    }

    InkList o-- InkListItem : keys
    InkList --> ListDefinition : origins
    ListDefinitionsOrigin o-- ListDefinition : holds
    ListValue --> InkList : wraps
}

' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' STATE CLASSES
' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

package "State" #E8EAF6 {

    class StoryState <<(T,#009688) TS>> {
        +{readonly} currentText: string
        +{readonly} currentTags: string[]
        +{readonly} currentChoices: Choice[]
        +{readonly} canContinue: boolean
        +{readonly} hasError: boolean
        +{readonly} hasWarning: boolean
        +{readonly} callStack: CallStack
        +{readonly} outputStream: InkObject[]
        +variablesState: VariablesState
        +evaluationStack: InkObject[]
        +currentTurnIndex: number
        +storySeed: number
        +previousRandom: number
        +divertedPointer: Pointer
        +didSafeExit: boolean
        +patch: StatePatch | null
        +currentFlow: Flow
        +{readonly} currentFlowName: string
        +{readonly} aliveFlowNames: string[]
        --
        +currentPointer: Pointer
        +previousPointer: Pointer
        +inExpressionEvaluation: boolean
        --
        +goToStart(): void
        +setChosenPath(path: Path, incrementTurn: boolean): void
        +switchFlowInternal(flowName: string): void
        +removeFlowInternal(flowName: string): void
        +forceEnd(): void
        +pushEvaluationStack(obj: InkObject): void
        +popEvaluationStack(count?: number): InkObject | InkObject[]
        +peekEvaluationStack(): InkObject
        +pushToOutputStream(obj: InkObject): void
        +popFromOutputStream(count: number): void
        +resetOutput(objs?: InkObject[]): void
        +visitCountForContainer(container: Container): number
        +incrementVisitCountForContainer(container: Container): void
        +turnsSinceForContainer(container: Container): number
        +copyAndStartPatching(): StoryState
        +applyAnyPatch(): void
        +toJson(): string
        +loadJson(jsonString: string): void
        ..
        +{static} INK_SAVE_STATE_VERSION: number
        +{static} MIN_COMPATIBLE_LOAD_VERSION: number
    }

    class CallStack <<(T,#009688) TS>> {
        +{readonly} elements: CallStack.Element[]
        +{readonly} depth: number
        +{readonly} currentElement: CallStack.Element
        +currentThread: CallStack.Thread
        +{readonly} canPop: boolean
        +{readonly} canPopThread: boolean
        +{readonly} elementIsEvaluateFromGame: boolean
        --
        +reset(): void
        +push(type: PushPopType, evalStackHeight?: number, outputLen?: number): void
        +pop(type?: PushPopType): void
        +pushThread(): void
        +popThread(): void
        +forkThread(): CallStack.Thread
        +threadWithIndex(index: number): CallStack.Thread | null
        +getTemporaryVariableWithName(name: string, contextIdx?: number): InkObject | null
        +setTemporaryVariable(name: string, value: InkObject, declareNew: boolean, contextIdx?: number): void
        +contextForVariableNamed(name: string): number
        +{readonly} callStackTrace: string
    }

    class "CallStack.Element" as CSElement <<(T,#009688) TS>> {
        +type: PushPopType
        +currentPointer: Pointer
        +inExpressionEvaluation: boolean
        +temporaryVariables: Map<string, InkObject>
        +evaluationStackHeightWhenPushed: number
        +functionStartInOutputStream: number
        --
        +copy(): CallStack.Element
    }

    class "CallStack.Thread" as CSThread <<(T,#009688) TS>> {
        +callstack: CallStack.Element[]
        +threadIndex: number
        +previousPointer: Pointer
        --
        +copy(): CallStack.Thread
    }

    class Flow <<(T,#009688) TS>> {
        +name: string
        +callStack: CallStack
        +outputStream: InkObject[]
        +currentChoices: Choice[]
        --
        +loadFlowChoiceThreads(jChoiceThreads: Map, cs?: CallStack): void
    }

    note bottom of Flow
      **â†’ ink.kt** : InkFlow implements **Flow<InkObject>**
      JS Flow is a data holder; Kotlin adds reactive stream.
      JS is single-threaded (event loop); KT coroutines
      map to cooperative scheduling on JS target.
      JS PRNG (custom RNG) â†’ KT kotlin.random.Random (seedable).
      JS Thread â†’ Kotlin **InkThread** (coroutine model).
      Multi-tenant: each session gets own InkFlow stream.
    end note

    class StatePatch <<(T,#009688) TS>> {
        +globals: Map<string, InkObject>
        +changedVariables: Set<string>
        +visitCounts: Map<Container, number>
        +turnIndices: Map<Container, number>
        --
        +getGlobal(name: string): InkObject | null
        +setGlobal(name: string, value: InkObject): void
        +addChangedVariable(name: string): void
        +getVisitCount(container: Container): number | null
        +setVisitCount(container: Container, count: number): void
        +getTurnIndex(container: Container): number | null
        +setTurnIndex(container: Container, index: number): void
    }

    class VariablesState <<(T,#009688) TS>> {
        +variableChangedEvent: VariableChangedCallback | null
        +patch: StatePatch | null
        +callStack: CallStack
        +{readonly} globalVariables: Map<string, InkObject>
        --
        +$(variableName: string): any
        +$$(variableName: string, value: any): void
        +assign(varAss: VariableAssignment, value: InkObject): void
        +getVariableWithName(name: string, contextIdx?: number): InkObject | null
        +getRawVariableWithName(name: string, contextIdx: number): InkObject | null
        +globalVariableExistsWithName(name: string): boolean
        +setGlobal(variableName: string, value: InkObject): void
        +snapshotDefaultGlobals(): void
        +applyPatch(): void
        +setJsonToken(jToken: object): void
        +runtimeObjectsEqual(a: InkObject, b: InkObject): boolean
        +iterator(): Iterator<string>
    }

    enum PushPopType <<(T,#009688) TS>> {
        Tunnel
        Function
        FunctionEvaluationFromGame
    }

    CallStack *-- CSElement : frames
    CallStack *-- CSThread : threads
    Flow *-- CallStack : owns
    StoryState *-- Flow : currentFlow / namedFlows
    StoryState *-- VariablesState : variablesState
    StoryState --> StatePatch : patch
    StoryState --> Pointer : currentPointer
    VariablesState --> StatePatch : patch overlay
    VariablesState --> CallStack : temp vars
}

' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' RUNTIME (Story â€” main entry point)
' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

package "Runtime" #FFF3E0 {

    class Story <<(T,#009688) TS>> {
        ' â”€â”€ Constructor â”€â”€
        +Story(jsonString: string)
        ' â”€â”€ Core narrative loop â”€â”€
        +canContinue: boolean
        +Continue(): string
        +ContinueAsync(millisecsLimitAsync: number): void
        +ContinueMaximally(): string
        +ContinueSingleStep(): boolean
        +{readonly} currentText: string
        +{readonly} currentTags: string[]
        +{readonly} currentChoices: Choice[]
        +{readonly} currentErrors: string[]
        +{readonly} currentWarnings: string[]
        +{readonly} hasError: boolean
        +{readonly} hasWarning: boolean
        ' â”€â”€ Choice selection â”€â”€
        +ChooseChoiceIndex(choiceIdx: number): void
        +ChoosePathString(path: string, resetCallstack?: boolean, args?: any[]): void
        ' â”€â”€ State management â”€â”€
        +{readonly} state: StoryState
        +ResetState(): void
        +ResetErrors(): void
        +ResetCallstack(): void
        ' â”€â”€ Variables â”€â”€
        +{readonly} variablesState: VariablesState
        +ObserveVariable(variableName: string, observer: VariableObserver): void
        +ObserveVariables(variableNames: string[], observer: VariableObserver): void
        +RemoveVariableObserver(observer?: VariableObserver, specificVariableName?: string): void
        ' â”€â”€ External functions â”€â”€
        +BindExternalFunction(funcName: string, func: Function, lookaheadSafe?: boolean): void
        +UnbindExternalFunction(funcName: string): void
        +HasFunction(funcName: string): boolean
        +EvaluateFunction(funcName: string, args?: any[]): any
        ' â”€â”€ Tags â”€â”€
        +{readonly} globalTags: string[]
        +TagsForContentAtPath(path: string): string[]
        ' â”€â”€ Flows â”€â”€
        +SwitchFlow(flowName: string): void
        +RemoveFlow(flowName: string): void
        +SwitchToDefaultFlow(): void
        +{readonly} aliveFlowNames: string[]
        +{readonly} currentFlowName: string
        +{readonly} currentFlowIsDefaultFlow: boolean
        ' â”€â”€ Save/Load â”€â”€
        +{readonly} state: StoryState
        ' â”€â”€ Knot/stitch visit counts â”€â”€
        +BuildStringOfHierarchy(): string
        +{readonly} mainContentContainer: Container
        ' â”€â”€ Callback types â”€â”€
        +onError: ErrorHandler | null
        +onDidContinue: Function | null
        +onMakeChoice: Function | null
        +onEvaluateFunction: Function | null
        +onCompleteEvaluateFunction: Function | null
        +onChoosePathString: Function | null
        ..
        +{static} inkVersionCurrent: number
        +{static} inkVersionMinimumCompatible: number
        +allowExternalFunctionFallbacks: boolean
    }
}

' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' SERIALIZATION
' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

package "Serialization" #F3E5F5 {

    class SimpleJson <<(T,#009688) TS>> {
        +{static} textToDictionary(text: string): object
        +{static} textToArray(text: string): any[]
    }

    class "SimpleJson.Writer" as SJWriter <<(T,#009688) TS>> {
        +writeObject(inner: Function): void
        +writeObjectStart(): void
        +writeObjectEnd(): void
        +writeArrayStart(): void
        +writeArrayEnd(): void
        +writeProperty(name: string, inner: Function): void
        +writePropertyStart(name: string): void
        +writePropertyEnd(): void
        +writePropertyNameStart(): void
        +writePropertyNameEnd(): void
        +writePropertyNameInner(str: string): void
        +write(val: any): void
        +writeStringStart(): void
        +writeStringEnd(): void
        +writeStringInner(str: string): void
        +toString(): string
    }

    class JsonSerialisation <<(T,#009688) TS>> {
        +{static} jTokenToRuntimeObject(token: any): InkObject | null
        +{static} runtimeObjectToJToken(obj: InkObject): any
        +{static} writeRuntimeContainer(writer: SimpleJson.Writer, container: Container): void
        +{static} jArrayToRuntimeObjList(jArray: any[]): InkObject[]
        +{static} writeDictionaryRuntimeObjs(writer: SimpleJson.Writer, dict: Map): void
        +{static} writeListRuntimeObjs(writer: SimpleJson.Writer, list: InkObject[]): void
    }

    SimpleJson *-- SJWriter
    JsonSerialisation --> SimpleJson : uses
}

' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' INHERITANCE HIERARCHY
' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

InkObject <|-- Container
InkObject <|-- Value
InkObject <|-- ChoicePoint
InkObject <|-- Choice
InkObject <|-- Divert
InkObject <|-- Glue
InkObject <|-- Tag
InkObject <|-- Void
InkObject <|-- ControlCommand
InkObject <|-- VariableAssignment
InkObject <|-- VariableReference
InkObject <|-- NativeFunctionCall

Container ..|> INamedContent : implements

' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' KEY ASSOCIATIONS
' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Story *-- StoryState : state
Story *-- Container : mainContentContainer
Story *-- ListDefinitionsOrigin : listDefinitions
Story --> Choice : produces
Story --> JsonSerialisation : save/load

StoryState --> Container : rootContentContainer
StoryState --> Choice : generatedChoices

Container o-- InkObject : content[]
Container --> SearchResult : contentAtPath()

InkObject --> Path : path
InkObject --> DebugMetadata : debugMetadata
InkObject --> Container : parent

Divert --> Path : targetPath
ChoicePoint --> Path : pathOnChoice
Choice --> Path : targetPath

' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' NOTES
' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

note as N1
  **inkjs vs C# / Java / Kotlin Comparison**
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  **Platform & Distribution**
  - JS is the most widely used ink port (npm: inkjs)
  - Published as both CommonJS and ESM modules
  - TypeScript types included (since inkjs 2.0+)
  - Used in web games, Electron apps, Node.js backends

  **API Parity**
  - Story is the main entry point â€” same API as other ports
  - All core methods: Continue(), ChooseChoiceIndex(),
    variablesState, save/load, external functions
  - canContinue / currentText / currentChoices / currentTags

  **Missing Features (JS only)**
  - **No Profiler / ProfileNode** (C#/Java/Kotlin only)
  - No Stopwatch â€” uses Date.now() where needed
  - No Stream overloads â€” string-only JSON I/O

  **Language Differences**
  - Prototype-based inheritance where C# uses class hierarchy
  - No strict typing (TS adds optional types)
  - JS runtime uses dynamic dispatch vs sealed/when in Kotlin
  - Module system: CommonJS/ESM vs C# namespaces vs Java packages

  **Variable Access**
  - inkjs: story.variablesState.$("varName")
  - C#:    story.variablesState["varName"]
  - Java:  story.getVariablesState().get("varName")
  - Kotlin: story.variablesState["varName"]  (operator)

  **Serialization**
  - JS: delegates to native JSON.parse + custom reviver
  - C#/Java: custom SimpleJson reader/writer
  - Kotlin: kotlinx.serialization.json reader + SimpleJson.Writer
end note

note as N2
  **Value Type Mapping**
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  JS number  <-> C# int / float
  JS boolean <-> C# bool
  JS string  <-> C# string
  JS null    <-> C# void

  In JS, Int and Float are both
  "number" â€” the runtime distinguishes
  via ValueType enum and rounding.
end note

note as N3
  **JS â†’ Kotlin/JS Porting Gap Analysis (2026-02-28)**
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  **All JS-unique features now ported to ink.kt** âœ…

  | Feature | inkjs | ink.kt | Status |
  | onDidContinue | âœ… callback | âœ… var | âœ… Ported as lambda |
  | onMakeChoice | âœ… callback | âœ… var | âœ… Ported as lambda |
  | onEvaluateFunction | âœ… callback | âœ… var | âœ… Ported as lambda |
  | onCompleteEvaluateFunction | âœ… callback | âœ… var | âœ… Ported as lambda |
  | onChoosePathString | âœ… callback | âœ… var | âœ… Ported as lambda |
  | ContinueSingleStep() | âœ… method | âœ… public | âœ… Ported |
  | currentFlowIsDefaultFlow | âœ… property | âœ… fun | âœ… Already existed |

  **Parser fields merged from mica into ink.kt data classes** âœ…
  - InkObject: +id, +text, +lineNumber, +count (from mica Content)
  - Container: +index, +children, +add(), +get()
  - Choice: +level, +conditions, +repeatable
  - Story: +parserMode fields

  **Ported differently (idiomatic Kotlin equivalents)**

  | inkjs | ink.kt | Note |
  | $("var") / $$("var", val) | operator get/set | story.variablesState["var"] |
  | prototype inheritance | sealed/when | Exhaustive dispatch |
  | Date.now() | TimeSource.Monotonic | Cross-platform |
  | JSON.parse + reviver | kotlinx.serialization.json | KMP-compatible reader |
  | CommonJS/ESM modules | KMP targets | JVM/JS/Native/WASM |

  **Missing from inkjs (ink.kt has)**

  | Feature | ink.kt | inkjs |
  | Profiler + ProfileNode | âœ… | â¬œ Not implemented |
  | Stopwatch | âœ… TimeSource | â¬œ Date.now() |
  | InkClock pluggable | âœ… | â¬œ |
  | InkRuntime interface | âœ… | â¬œ |
  | sealed Value hierarchy | âœ… exhaustive | â¬œ class chain |

  **Kotlin/JS compilation strategy**
  ink.kt compiles to JS via Kotlin/JS compiler.
  Same JS API surface as inkjs â€” interop via
  @JsExport on Story, Choice, VariablesState.
  Browser/Node: CommonJS + ESM dual publish.
  KT/JS will run alongside inkjs in browser.
  Event callbacks = Kotlin fun interfaces
  which compile to JS function types.
end note

note as N4
  **Merge Status & Architecture (2026-02-28)**
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  **mica â†’ ink.kt merge status**
  - mica fully KMP-ported: all 6 JVM deps replaced
    (BigDecimalâ†’Double, Jacksonâ†’kotlinx.serialization, etc.)
  - Parser fields merged into ink.kt data classes
  - All 5 JS event callbacks ported to ink.kt âœ…
  - ContinueSingleStep() now public in ink.kt âœ…
  - **Next**: Move 22 non-colliding mica classes to
    ink.kt package, then delete mica/ directory

  **Code-first three-layer architecture**
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 1. **ink.model**                    â”‚
  â”‚    Kotlin data classes + annotationsâ”‚
  â”‚    â†’ generates proto, OpenAPI,      â”‚
  â”‚      MCP, AsyncAPI schemas          â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ 2. **ink.kt**                       â”‚
  â”‚    Runtime classes                  â”‚
  â”‚    (extend model data classes)      â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ 3. **ink.kt.services**              â”‚
  â”‚    Companion objects per data class â”‚
  â”‚    (ink language logic)             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  **Compiler strategy (3 compilers â†’ identical JSON)**
  - C# inklecate: UNCHANGED â€” reference compiler, test oracle
  - Java blade-ink: UNCHANGED â€” reference compiler, test oracle
  - KT/KMP: NEW compiler, validated against C# + Java JSON
  - inkjs: remains as browser runtime; KT/JS runs alongside
end note

note as N_INKKT
  **ink.[lang].puml Cross-Reference (2026-03-01)**
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  See **ink.kt.puml** for complete
  56-class diagram with method-level
  cross-language line references.

  **All 8 ink.[lang].puml diagrams:**
  | Diagram | Language | Focus |
  | ink.kt.puml | Kotlin | Runtime (56 classes) |
  | ink.proto.puml | proto3 | Messages (16 files) |
  | ink.java.puml | Java | blade-ink + mica (page 2) |
  | ink.cs.puml | C# | inkle reference |
  | ink.js.puml | JS/TS | inkjs + ink/js (this file) |
  | **ink.ts.puml** | **TS** | **Proto model (NEW)** |
  | **ink.py.puml** | **PY** | **Proto model (NEW)** |
end note

N1 .. Story
N2 .. Value
N3 .. StoryState
N4 .. Story
N_INKKT .. VariablesState

' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' INK/JS COMPONENT ARCHITECTURE (2026-02-28)
' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

package "ink/js/[component]" as InkJsComponents #E3F2FD {

    package "ink/js/electron" as Electron #BBDEFB {
        class "main.js" as ElMain <<(J,#1565C0) JS>> {
            Electron entry point
            App lifecycle + IPC
            --
            ipcMain.handle()
            ipcMain.on()
        }
        class "inklecate.js" as ElInklecate <<(J,#1565C0) JS>> {
            inklecate subprocess
            --
            child_process.spawn()
            error regex parsing
            bidifyJson() post-process
            session management
        }
        class "playerView.js" as ElPlayer <<(J,#1565C0) JS>> {
            Story playback (jQuery)
            --
            addTextSection(text)
            addChoice(choice, cb)
            addTerminatingMessage()
            word-level spans (source map)
            Alt-click â†’ jump to source
            double-buffer sessions
            bidify() RTL support
        }
        class "bidify.js" as ElBidify <<(J,#1565C0) JS>> {
            Unicode Bidi utility
            --
            bidify(text) â†’ LRI/RLI/PDI
            stripBidi(text)
            bidifyJson(jsonStr)
            bidifyLine(line)
            isRTL(cp) / isLTR(cp)
        }
        class "liveCompiler.js" as ElLive <<(J,#1565C0) JS>> {
            Debounced recompilation
            --
            ipc â†’ inklecate.js
            500ms edit debounce
            replay choice sequence
        }
        class "inkProject.js" as ElProject <<(J,#1565C0) JS>> {
            Project model + file tree
            --
            chokidar file watching
            INCLUDE resolution
            symbol scoping
            export (JSON/JS/web)
        }
        class "ace-ink.js" as AceInk <<(J,#1565C0) JS>> {
            Ace editor ink mode
            --
            syntax highlighting rules
            folding (knot/stitch)
            autocompletion (keywords)
        }
    }

    package "ink/js/editor" as Editor #C8E6C9 {
        note as N_EDITOR
          **Web-based alternative editor (not used by electron or ai)**
          electron/ and ai/ use **Ace** directly (ace-ink.js).
          This package is an independent React-based editor
          for web/MAUI/embedded contexts.
          ```ink blocks in markdown use **Ace** by default.
        end note
        class "ink-js-language" as EdLang <<(T,#2E7D32) TS>> {
            Shared ink grammar
            --
            classifyLine(line)
            ~65+ regex patterns
            INK_KEYWORDS (17)
            INK_BUILTIN_FUNCTIONS (10)
            InkTokenType / InkLineType
        }
        class "ink-js-codemirror" as EdCM <<(T,#2E7D32) TS>> {
            CodeMirror 6 extension
            --
            inkStreamParser (tokenizer)
            inkHighlightStyle (colors)
            inkCompletionSource
            inkFolding (knot/stitch)
            inkYjsExtension (collab)
        }
        class "ink-js-remirror" as EdRM <<(T,#2E7D32) TS>> {
            Remirror/ProseMirror ext
            (markdown + embedded ink)
            --
            InkExtension (commands)
            ink-node-view (```ink blocks)
            ..Ace (default) or CM6..
            ink-schema (knot/choice specs)
            ink-yjs (collab Y.Doc)
        }
        class "ink-js-react-editor" as EdReact <<(T,#2E7D32) TS>> {
            React components (web UI)
            --
            InkEditorProvider (context)
            InkCodeEditor (CM6 standalone)
            InkRemirrorEditor (MD+Ace)
            InkPlayer / InkPlayPreview
            InkRuntimeAdapter (3 backends)
            AssetEventClient (msgpack)
            ModeToggle (Edit/Play)
            ..
            InkAiProvider (AI context)
            useInkAi() hook
        }
    }

    package "ink/js/pwa" as Pwa #FFE0B2 {
        class "background.js" as PwaBg <<(J,#E65100) JS>> {
            Service worker
            --
            MCP JSON-RPC 2.0 client
            chrome.runtime messaging
            fetch â†’ /message endpoint
            callTool(name, args)
        }
        class "sidepanel.js" as PwaSide <<(J,#E65100) JS>> {
            Editor + Player + Debug
            --
            handleStory(resp)
            choice rendering loop
            story history accumulation
            tab switching (3 panels)
        }
        class "popup.js" as PwaPopup <<(J,#E65100) JS>> {
            Quick play popup
            --
            handleStoryResponse(resp)
            choice rendering loop
            server connect UI
        }
        class "content.js" as PwaContent <<(J,#E65100) JS>> {
            Content script
            --
            detect <script type=ink+json>
            detect <pre class=ink>
            detect <a href=*.ink>
            inject Play buttons
        }
    }

    package "ink/js/ai" as Ai #F3E5F5 {
        class "compiler.js" as AiCompiler <<(J,#6A1B9A) JS>> {
            inklecate wrapper
            --
            compile(inkFilePath)
            validate(inkFilePath)
            parseOutput(output)
            isAvailable() / getVersion()
        }
        class "llmClient.js" as AiLlm <<(J,#6A1B9A) JS>> {
            OpenAI-compatible LLM
            --
            chat() / chatStream()
            generateInkCode(prompt)
            fixErrors(code, errors, docs)
            explain(query, code, docs)
        }
        class "vectorStore.js" as AiVec <<(J,#6A1B9A) JS>> {
            Supabase RAG
            --
            generateEmbedding(text)
            search(query, limit)
            batchInsert(documents)
            formatForContext(results)
        }
        class "fileWatcher.js" as AiWatch <<(J,#6A1B9A) JS>> {
            chokidar file watch
            --
            watch(paths, callbacks)
            auto-compile on change
        }
        class "errorParser.js" as AiErr <<(J,#6A1B9A) JS>> {
            Error enhancement
            --
            enhanceErrors(errors)
            suggestQuickFixes(error)
            summarizeForAI(errors)
        }
        class "mcpLlmClient.js" as AiMcp <<(J,#6A1B9A) JS>> {
            MCP-backed LLM client
            (drop-in for llmClient.js)
            --
            chat() / chatStream()
            generateInkCode() / fixErrors()
            explain() / chatAboutInk()
            reviewInk() / translateToHebrew()
            generateCompilePlay()
            listModels() / loadModel()
            listServices() / connectService()
            isAvailable() / getConfig()
        }
    }

    package "ink/js/web-export" as WebExport #FFECB3 {
        class "main.js" as WeMjs <<(J,#F57F17) JS>> {
            Standalone story player
            --
            continueStory(firstTime)
            restart() / save / load
            setupTheme() / setupDirection()
            tag dispatch (AUDIO, IMAGE, ...)
            localStorage save/load
            smooth scroll + fade-in
        }
    }

    package "ink/js/common" as Common #E8F5E9 {
        class "@inky/common" as CommonPkg <<(T,#1B5E20) TS>> {
            Shared utilities (Phase 1)
            ==
            **mcp-client.ts**
            parseMcpResponse<T>(resp)
            parseMcpResponseSafe<T>(resp)
            buildMcpRequest(tool, args)
            callMcpTool<T>(url, tool, args)
            checkMcpHealth(url)
            --
            **inklecate-runner.ts**
            parseInklecateIssue(line)
            parseInklecateOutput(output)
            getInklecateBinaryName(platform?)
            findInklecatePath(options?)
            getTempCompileDir(namespace?)
            stripBom(text)
            --
            **ai-mcp-client.ts (81 tools)**
            InkMcpClient(serverUrl)
            ..Ink (17): compile/play/bidi..
            compileInk() / startStory() / choose()
            continueStory() / get/setVariable()
            save/loadState() / bidify/stripBidi()
            ..Debug (8): breakpoints/watches..
            startDebug() / debugStep/Continue()
            addBreakpoint() / addWatch()
            ..Edit (6): parse/sections..
            parseInk() / getSection()
            replaceSection() / renameSection()
            ..Ink+MD (3) / PlantUML (5)..
            parseInkMd() / ink2puml() / ink2svg()
            ..LLM (8): chat/generate/review..
            chat() / generateInk() / reviewInk()
            translateToHebrew() / fixErrors()
            ..Services (2) / Collab (2)..
            listServices() / connectService()
            ..Calendar (4) / vCard (4) / Auth (2)..
            ..WebDAV (10): list/get/put/backup..
            ..Assets (10): emoji/faker/events..
        }
    }

    ' â”€â”€ Dependencies â”€â”€

    ' Editor internal deps
    EdCM --> EdLang : imports grammar
    EdRM --> EdLang : imports grammar
    EdRM ..> EdCM : CM6 option for ```ink blocks
    EdRM --> AceInk : **Ace (default)** for ```ink blocks
    EdReact --> EdCM : InkCodeEditor (standalone .ink)
    EdReact --> EdRM : InkRemirrorEditor (MD+ink)
    EdReact --> CommonPkg : callMcpTool

    ' PWA uses shared MCP helpers
    PwaPopup ..> CommonPkg : parseMcpResponseSafe
    PwaSide ..> CommonPkg : parseMcpResponseSafe

    ' Electron and AI use Ace directly (NOT the react editor)
    ElMain --> AceInk : **primary editor**

    ' AI MCP client dependencies
    EdReact --> CommonPkg : AiMcpClient (InkAiAdapter)
    AiMcp --> CommonPkg : AiMcpClient (wraps MCP tools)
    ElMain --> AiMcp : MCP-first, fallback to LLMClient
}


' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' DUPLICATION ANALYSIS â€” MERGE CANDIDATES
' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

note as N_DUP1
  **ğŸ”´ HIGH: Story Player â€” 3 implementations (~900 lines)**
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  All three render story text + choices from inkjs Story API.

  | File | Lines | Framework | Features |
  |------|-------|-----------|----------|
  | **web-export/main.js** | 456 | vanilla DOM | save/load, themes, tags, audio/image, scroll anim |
  | **electron/playerView.js** | 335 | jQuery | multi-session buffers, word-level source map, Alt-click |
  | **pwa/sidepanel.js** | 93 | vanilla DOM | MCP message-based, history tracking |

  **Common logic to extract â†’ ink/js/shared/storyPlayer.js:**
  - Choice rendering loop (create button, wire click â†’ chooseIndex)
  - Story text paragraph splitting + append
  - "â€” The End â€”" termination message
  - Fade-in animation (shared timing, respects prefers-reduced-motion)
  - RTL direction setup (dir="auto" / "rtl" class)
  - Tag dispatching (AUDIO, IMAGE, CLEAR, CLASS, etc.)

  **Unique per-component (keep separate):**
  - electron: word-level spans, Alt-click source map, double-buffer sessions
  - web-export: localStorage save/load, standalone HTML template
  - pwa: chrome.runtime.sendMessage async, MCP response parsing
end note

note as N_DUP2
  **ğŸ”´ HIGH: Compiler/inklecate â€” 2 implementations (~410 lines)**
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Both spawn inklecate, parse stderr, manage temp files.

  | File | Lines | Extras |
  |------|-------|--------|
  | **electron/inklecate.js** | ~350 | export JSON, bidifyJson, play mode, stats, multi-session |
  | **ai/compiler.js** | ~205 | validate mode, isAvailable(), getVersion() |

  **Merge â†’ ink/js/shared/inklecate.js:**
  - child_process.spawn() with platform-aware paths
  - stderr regex parsing: /^(ERROR|WARNING|TODO|AUTHOR):\s+/
  - Temp file creation (mkdirp + unique paths)
  - Session tracking (sessionId â†’ process map)

  **Keep separate:**
  - electron: bidifyJson() post-processing, play/choice IPC, export formats
  - ai: validate-only mode (/dev/null output), version detection
end note

note as N_DUP3
  **ğŸŸ¡ MEDIUM: MCP Response Parsing â€” 3 implementations (~60 lines)**
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Identical JSON-RPC 2.0 response extraction logic duplicated.

  | File | Pattern |
  |------|---------|
  | **pwa/popup.js** | resp.result?.content?.[0]?.text â†’ JSON.parse |
  | **pwa/sidepanel.js** | resp?.result?.content?.[0]?.text â†’ JSON.parse |
  | **editor/InkRuntimeAdapter.ts** | data.result?.content?.[0]?.text â†’ JSON.parse |

  **Merge â†’ ink/js/shared/mcpClient.js:**
  - parseMcpResponse(resp) â†’ { text, choices, sessionId, canContinue }
  - callTool(serverUrl, toolName, args) â†’ JSON-RPC 2.0 POST
  - checkHealth(serverUrl) â†’ boolean
end note

note as N_DUP4
  **ğŸŸ¡ MEDIUM: Choice Rendering â€” 4 implementations**
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  All create button/link elements with choice.text + click handler.

  | File | Element | Click Handler |
  |------|---------|---------------|
  | **web-export/main.js** | <a class="choice"> | story.ChooseChoiceIndex(idx) |
  | **electron/playerView.js** | <a class="choice"> | callback(choice) |
  | **pwa/popup.js** | <button class="choice-btn"> | sendMessage({type:'choose'}) |
  | **pwa/sidepanel.js** | <button class="choice"> | sendMessage({type:'choose'}) |

  popup.js lines 76-89 â‰¡ sidepanel.js lines 71-85 (character-identical)

  **Merge â†’ ink/js/shared/renderChoices.js:**
  - renderChoices(container, choices, onChoose, opts?)
  - opts: { elementTag, className, animate }
end note

note as N_DUP5
  **ğŸŸ¡ MEDIUM: Syntax Highlighting â€” Ace vs CodeMirror (~500 lines overlap)**
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  **ace-ink.js** is the canonical ink editor mode, used by:
    - electron/ (primary .ink editor)
    - ai/ (AI assistant editor)
    - editor/ink-js-remirror (```ink blocks in markdown â€” **default**)
  **ink-js-language** extracts shared regex patterns; CodeMirror uses them.

  | Feature | ace-ink.js | ink-js-codemirror | Shared in ink-js-language |
  |---------|-----------|-------------------|---------------------------|
  | Regex patterns | inline | imported | âœ… source of truth |
  | Folding | ~70 lines | ~40 lines | â¬œ extract foldRange() |
  | Autocompletion | ~70 lines | ~20 lines | â¬œ extract completions |
  | Color theme | CSS classes | HighlightStyle | (separate â€” different frameworks) |

  **Merge opportunity:**
  - ace-ink.js folding should import FOLD_START/KNOT_BOUNDARY from ink-js-language
  - ace-ink.js keywords array should import INK_KEYWORDS from ink-js-language
  - Extract foldRange(lines, startLine, isKnot) to ink-js-language
end note

note as N_DUP6
  **ğŸŸ¡ MEDIUM: File Watching â€” 2 implementations**
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Both use chokidar with similar config.

  | File | Pattern |
  |------|---------|
  | **electron/inkProject.js** | chokidar.watch() + auto-reload includes |
  | **ai/fileWatcher.js** | chokidar.watch() + auto-compile |

  **Merge â†’ ink/js/shared/inkFileWatcher.js:**
  - watch(paths, { onFileChange, onError })
  - Shared chokidar config (ignoreInitial, awaitWriteFinish, dotfiles)
end note

note as N_DUP7
  **ğŸŸ¢ LOW: Electron Boilerplate â€” 2 Electron apps**
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  electron/ and ai/ both have:
  - BrowserWindow creation with contextIsolation
  - preload.js exposing IPC via contextBridge
  - ipcMain.handle() / ipcMain.on() patterns
  - File dialog operations
  - Dark theme CSS with similar variables

  **Merge â†’ ink/js/shared/electronSetup.js:**
  - createSecureWindow(opts) (webPreferences, preload, devTools)
  - Standard IPC channel helpers
end note

note as N_DUP8
  **ğŸŸ¢ LOW: Config / Inklecate Path Detection**
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ai/config.js has clean getInklecatePath() with
  multi-path search (sibling install, home dir, env var).
  electron/inklecate.js has inline path logic.

  **Merge â†’ ink/js/shared/config.js**
end note

note as N_DUP9
  **ğŸŸ¢ LOW: Test Helper Duplication**
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  jsTest/ink/js/test.js re-implements ~60% of
  e2e-helpers.js inline (launchApp, setEditorContent,
  waitForStoryText, waitForChoice, etc.).

  **Fix: import from e2e-helpers.js instead.**
end note

N_DUP1 .. ElPlayer
N_DUP1 .. WeMjs
N_DUP1 .. PwaSide
N_DUP2 .. ElInklecate
N_DUP2 .. AiCompiler
N_DUP3 .. PwaPopup
N_DUP3 .. PwaSide
N_DUP4 .. ElPlayer
N_DUP4 .. PwaPopup
N_DUP5 .. AceInk
N_DUP5 .. EdCM
N_DUP6 .. ElProject
N_DUP6 .. AiWatch
N_DUP7 .. ElMain
N_DUP8 .. AiCompiler

@enduml
