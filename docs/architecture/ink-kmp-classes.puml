@startuml ink-kmp-classes
!theme plain
skinparam backgroundColor #FEFEFE
skinparam classAttributeIconSize 0

title Ink KMP + MCP Server — Class Diagram\n(31 commonMain classes ported from C#/Java/JS three-way comparison)
footer blade-ink-java | inkjs | KMP Runtime (31 classes) | MCP Tools | Asset Pipeline | RSocket EDA

' ───────── blade-ink-java API ─────────
package "blade-ink-java (JVM)" #E3F2FD {
    class "Story" as BStory {
        +Story(jsonString: String)
        +canContinue(): Boolean
        +Continue(): String
        +getCurrentChoices(): List<Choice>
        +chooseChoiceIndex(idx: Int)
        +getVariablesState(): VariablesState
        +toJson(): String
        +resetState()
        +getGlobalTags(): List<String>
        +evaluateFunction(name: String, args: Object[]): Object
        +bindExternalFunction(name: String, fn: Function)
    }

    class "Choice" as BChoice {
        +index: Int
        +text: String
        +tags: List<String>
    }

    class "Compiler" as BCompiler {
        +Compiler(inkSource: String)
        +compile(): Story
    }

    BStory --> BChoice : produces
    BCompiler --> BStory : creates
}

' ───────── inkjs API (JS via GraalJS) ─────────
package "inkjs (JS)" #E8F5E9 {
    class "inkjs.Story" as JStory <<JavaScript>> {
        +constructor(jsonString)
        +canContinue: boolean
        +Continue(): string
        +currentChoices: Choice[]
        +currentTags: string[]
        +ChooseChoiceIndex(idx)
        +variablesState[name]
        +state.ToJson(): string
        +state.LoadJson(json)
        +ResetState()
        +globalTags: string[]
        +EvaluateFunction(name, args)
        +BindExternalFunction(name, fn)
        +HasFunction(name): boolean
    }

    class "inkjs.Compiler" as JCompiler <<JavaScript>> {
        +constructor(source, options?, errorHandler?)
        +Compile(): Story
    }

    class "inkjs.Choice" as JChoice <<JavaScript>> {
        +index: number
        +text: string
        +tags: string[]
    }

    JStory --> JChoice
    JCompiler --> JStory
}

' ───────── MCP Server (Kotlin) ─────────
package "Inky MCP Server (Kotlin/JVM)" #FFEBEE {
    class "InkEngine" {
        -inkjsSource: String
        -bidifySource: String?
        -sessions: ConcurrentHashMap
        +compile(source: String): CompileResult
        +startSession(source: String): (String, ContinueResult)
        +startSessionFromJson(json: String): (String, ContinueResult)
        +continueStory(sessionId: String): ContinueResult
        +choose(sessionId: String, idx: Int): ContinueResult
        +getVariable(sessionId: String, name: String): Any?
        +setVariable(sessionId: String, name: String, value: Any?)
        +saveState(sessionId: String): String
        +loadState(sessionId: String, stateJson: String)
        +resetStory(sessionId: String): ContinueResult
        +evaluateFunction(sessionId: String, name: String, args: List): Any?
        +bidify(text: String): String
        +stripBidi(text: String): String
        +bidifyJson(json: String): String
        +endSession(sessionId: String)
    }

    class "McpTools" {
        -engine: InkEngine
        +tools: List<McpToolInfo>
        +callTool(name: String, args: JsonObject?): McpToolResult
    }

    class "McpRouter" <<Ktor>> {
        +startServer(port: Int, inkjsPath: String, bidifyPath: String?)
        -handleRpcRequest(req: JsonRpcRequest, tools: McpTools): JsonRpcResponse
    }

    class "StorySession" {
        +id: String
        +context: GraalJS Context
        +source: String
        +stateJson: String?
    }

    class "CompileResult" {
        +success: Boolean
        +json: String?
        +errors: List<String>
        +warnings: List<String>
    }

    class "ContinueResult" {
        +text: String
        +canContinue: Boolean
        +choices: List<ChoiceInfo>
        +tags: List<String>
    }

    InkEngine --> StorySession : manages
    InkEngine --> CompileResult : produces
    InkEngine --> ContinueResult : produces
    McpTools --> InkEngine : delegates to
    McpRouter --> McpTools : dispatches
}

' ───────── KMP commonMain Runtime (Ported — 31 classes) ─────────
package "ink-kmp-mcp/commonMain\n(Kotlin Multiplatform — 31 classes ported)" #E0F7FA {

    package "Tier 0 — Enums & Exceptions" as T0 {
        class "ValueType" as KValueType <<enum>> { IntValue, FloatValue, BoolValue, StringValue,\nDivertTarget, VariablePointer, List }
        class "PushPopType" as KPushPop <<enum>> { Tunnel, Function, FunctionEvaluationFromGame }
        class "ErrorType" as KErrorType <<enum>> { Author, Warning, Error }
        class "StoryException" as KStoryExc { class : Exception }
    }

    package "Tier 1 — Base & Structural" as T1 {
        class "InkObject" as KInkObj { open class\n  parent, debugMetadata\n  path, rootContentContainer }
        class "INamedContent" as KINamed <<interface>> { name: String, hasValidName: Boolean }
        class "DebugMetadata" as KDebugMeta <<data>> { startLineNumber, endLineNumber,\n  startCharacterNumber, endCharacterNumber,\n  fileName, sourceName }
        class "Path" as KPath { class + Component\n  componentsString, isRelative }
        class "Pointer" as KPointer <<data>> { container: Container?, index: Int\n  Null companion }
        class "SearchResult" as KSearchResult { obj: InkObject?, approximate: Boolean }
        class "Container" as KContainer { class : InkObject, INamedContent\n  content, namedContent\n  countFlags, pathToFirstLeafContent }
    }

    package "Tier 2 — Leaf Objects" as T2 {
        class "Glue" as KGlue { : InkObject }
        class "Void" as KVoid { : InkObject }
        class "Tag" as KTag { : InkObject\n  text: String }
        class "ControlCommand" as KCtrlCmd { : InkObject\n  enum CommandType (19 values) }
        class "Divert" as KDivert { : InkObject\n  targetPath, isExternal, isConditional }
        class "ChoicePoint" as KChoicePt { : InkObject\n  hasCondition, hasStartContent }
        class "VariableAssignment" as KVarAss { : InkObject\n  variableName, isNewDeclaration, isGlobal }
        class "VariableReference" as KVarRef { : InkObject\n  name, pathForCount }
    }

    package "Tier 3 — Value Hierarchy (sealed)" as T3 {
        class "Value<T>" as KValue <<sealed>> { : InkObject\n  valueType, isTruthy, cast() }
        class "BoolValue" as KBoolV { }
        class "IntValue" as KIntV { }
        class "FloatValue" as KFloatV { }
        class "StringValue" as KStringV { isNewline, isInlineWhitespace }
        class "DivertTargetValue" as KDivertV { }
        class "VariablePointerValue" as KVarPtrV { variableName, contextIndex }
        class "ListValue" as KListV { }
    }

    package "Tier 4 — List System" as T4 {
        class "InkListItem" as KListItem <<data>> { originName, itemName }
        class "InkList" as KInkList { : MutableMap by LinkedHashMap\n  operator +/- union/intersect\n  maxItem, minItem, inverse }
        class "ListDefinition" as KListDef { lazy items: LinkedHashMap }
        class "ListDefinitionsOrigin" as KListDefOrigin { findSingleItemListWithName }
    }

    package "Tier 5 — Execution Engine" as T5 {
        class "Choice" as KChoice { : InkObject, Comparable<Choice>\n  threadAtGeneration: Thread? }
        class "NativeFunctionCall" as KNativeFunc { : InkObject\n  fun interface BinaryOp\n  fun interface UnaryOp\n  (supplier functional pattern) }
        class "CallStack" as KCallStack { Element, Thread\n  LinkedHashMap temps\n  FIXED: Java infinite recursion }
        class "CallStack.Element" as KCSElement { type, currentPointer\n  temporaryVariables: LinkedHashMap }
        class "CallStack.Thread" as KCSThread { callstack, threadIndex\n  previousPointer, copy() }
        class "Flow" as KFlow { var name, callStack\n  outputStream, currentChoices }
        class "StatePatch" as KStatePatch { globals: LinkedHashMap\n  visitCounts, turnIndices\n  changedVariables: LinkedHashSet }
        class "VariablesState" as KVarState { : Iterable<String>\n  fun interface VariableChanged\n  operator get/set\n  patch: StatePatch? }
    }

    package "Tier 6 — State" as T6 {
        class "StoryState" as KStoryState { enum OutputOp (functional)\n  fun interface ErrorHandler\n  fun interface OnDidLoadState\n  LinkedHashMap visitCounts/turnIndices\n  TreeMap<Choice> via Comparable }
        class "Json" as KJson <<stub>> { jTokenToRuntimeObject (stub) }
    }

    ' Internal relationships
    KInkObj <|-- KContainer
    KInkObj <|-- KValue
    KInkObj <|-- KGlue
    KInkObj <|-- KVoid
    KInkObj <|-- KTag
    KInkObj <|-- KCtrlCmd
    KInkObj <|-- KDivert
    KInkObj <|-- KChoicePt
    KInkObj <|-- KVarAss
    KInkObj <|-- KVarRef
    KInkObj <|-- KChoice
    KInkObj <|-- KNativeFunc

    KValue <|-- KBoolV
    KValue <|-- KIntV
    KValue <|-- KFloatV
    KValue <|-- KStringV
    KValue <|-- KDivertV
    KValue <|-- KVarPtrV
    KValue <|-- KListV

    KContainer o-- KINamed
    KCallStack *-- KCSElement
    KCallStack *-- KCSThread
    KFlow --> KCallStack
    KFlow --> KChoice
    KVarState --> KCallStack
    KVarState --> KStatePatch
    KVarState --> KListDefOrigin
    KStoryState --> KVarState
    KStoryState --> KFlow
    KStoryState --> KCallStack
}

' ───────── Asset Pipeline (Kotlin/JVM) ─────────
package "Asset Pipeline (Kotlin/JVM)" #B2DFDB {
    class "EmojiAssetManifest" {
        -categories: Map<String, AssetCategory>
        +resolve(emoji: String): AssetRef?
        +resolveByName(name: String): AssetRef?
        +resolveTag(key: String, value: String): AssetRef?
        +parseInkTags(tags: List<String>): List<AssetRef>
    }

    class "AssetCategory" <<data>> {
        +emoji: String
        +name: String
        +type: String
        +animSet: String
        +gripType: String
        +meshPrefix: String
        +audioCategory: String
    }

    class "VoiceRef" <<data>> {
        +characterId: String
        +language: String
        +flacPath: String
    }

    class "AssetRef" <<data>> {
        +emoji: String
        +category: AssetCategory
        +meshPath: String
        +animSetId: String
        +voiceRef: VoiceRef?
        +metadata: Map<String, String>
    }

    class "InkAssetEventEngine" {
        -manifest: EmojiAssetManifest
        -bus: AssetEventBus
        +processTagsFromContinue(sessionId: String, result: ContinueResult): List<AssetEvent>
        +processInventoryChange(sessionId: String, action: String, emoji: String): AssetEvent
    }

    class "AssetEvent" <<data>> {
        +type: String
        +sessionId: String
        +emoji: String
        +assetRef: AssetRef
        +timestamp: Long
    }

    class "AssetEventBus" {
        -subscribers: Map<String, Flow<AssetEvent>>
        +publish(channel: String, event: AssetEvent)
        +subscribe(channel: String): Flow<AssetEvent>
        +fireAndForget(event: AssetEvent)
        +requestStream(sessionId: String): Flow<AssetEvent>
    }

    class "InkFakerEngine" {
        -manifest: EmojiAssetManifest
        +generateCharacter(config: FakerConfig): Map<String, Any>
        +generateItem(config: FakerConfig): Map<String, Any>
        +generateInkVars(data: Map<String, Any>): String
        +generateStoryMd(characters: List, items: List): String
    }

    class "FakerConfig" <<data>> {
        +locale: String
        +seed: Long?
        +count: Int
    }

    class "ChatterboxTtsEngine" {
        +synthesize(text: String, voiceRef: VoiceRef, language: String): ByteArray
        +listVoices(): List<VoiceRef>
        +isAvailable(): Boolean
    }

    EmojiAssetManifest --> AssetCategory : maps emoji →
    EmojiAssetManifest --> AssetRef : produces
    AssetRef --> AssetCategory
    AssetRef --> VoiceRef
    InkAssetEventEngine --> EmojiAssetManifest : resolves
    InkAssetEventEngine --> AssetEventBus : publishes
    InkAssetEventEngine --> AssetEvent : produces
    InkFakerEngine --> EmojiAssetManifest : generates from
    ChatterboxTtsEngine --> VoiceRef : uses
}

' ───────── Cross-package relations ─────────
InkEngine ..> JCompiler : via GraalJS
InkEngine ..> JStory : via GraalJS

' KMP runtime replaces blade-ink-java internals
KStoryState ..> BStory : replaces internal\nstate management
KContainer ..> BStory : replaces internal\ncontent model

' McpTools delegates
McpTools --> InkAssetEventEngine : delegates
McpTools --> InkFakerEngine : delegates
McpTools --> ChatterboxTtsEngine : delegates
InkAssetEventEngine --> InkEngine : triggers ink blocks

note bottom of T0
    C# = primary reference
    Java/JS = secondary
    See: INK_KMP_PORT.md
    See: ink-kmp-port-status.puml
end note

@enduml
